import { useState, useMemo } from "react";
import { base44 } from "@/api/base44Client";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { Link } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { motion } from "framer-motion";
import { 
  ArrowLeft, 
  UserPlus, 
  Search, 
  Users,
  DollarSign,
  AlertCircle,
  CheckCircle2,
  Filter
} from "lucide-react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";

import DebtorCard from "@/components/debtors/DebtorCard";
import DebtorForm from "@/components/debtors/DebtorForm";
import PaymentModal from "@/components/debtors/PaymentModal";

export default function Debtors() {
  const [isFormOpen, setIsFormOpen] = useState(false);
  const [isPaymentOpen, setIsPaymentOpen] = useState(false);
  const [selectedDebtor, setSelectedDebtor] = useState(null);
  const [editingDebtor, setEditingDebtor] = useState(null);
  const [searchTerm, setSearchTerm] = useState("");
  const [filterStatus, setFilterStatus] = useState("all");

  const queryClient = useQueryClient();

  const { data: debtors = [], isLoading } = useQuery({
    queryKey: ['debtors'],
    queryFn: () => base44.entities.Debtor.list('-created_date', 500),
  });

  const createMutation = useMutation({
    mutationFn: (data) => base44.entities.Debtor.create(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['debtors'] });
      setIsFormOpen(false);
      setEditingDebtor(null);
    },
  });

  const updateDebtorMutation = useMutation({
    mutationFn: ({ id, data }) => base44.entities.Debtor.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['debtors'] });
      setIsFormOpen(false);
      setEditingDebtor(null);
    },
  });

  const updateMutation = useMutation({
    mutationFn: ({ id, data }) => base44.entities.Debtor.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['debtors'] });
      setIsPaymentOpen(false);
      setSelectedDebtor(null);
    },
  });

  const deleteMutation = useMutation({
    mutationFn: (id) => base44.entities.Debtor.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['debtors'] });
    },
  });

  const handlePayment = async (id, data) => {
    await updateMutation.mutateAsync({ id, data });
  };

  const openPaymentModal = (debtor) => {
    setSelectedDebtor(debtor);
    setIsPaymentOpen(true);
  };

  const openEditModal = (debtor) => {
    setEditingDebtor(debtor);
    setIsFormOpen(true);
  };

  const handleFormSubmit = async (data) => {
    if (editingDebtor) {
      await updateDebtorMutation.mutateAsync({ id: editingDebtor.id, data });
    } else {
      await createMutation.mutateAsync(data);
    }
  };

  // Filtered debtors
  const filteredDebtors = useMemo(() => {
    return debtors.filter(d => {
      const matchesSearch = d.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                           d.phone?.includes(searchTerm) ||
                           d.description?.toLowerCase().includes(searchTerm.toLowerCase());
      
      const matchesStatus = filterStatus === "all" || d.status === filterStatus;
      
      return matchesSearch && matchesStatus;
    });
  }, [debtors, searchTerm, filterStatus]);

  // Stats
  const stats = useMemo(() => {
    const total = debtors.length;
    const totalDebt = debtors.reduce((sum, d) => sum + (d.total_debt || 0), 0);
    const totalPaid = debtors.reduce((sum, d) => sum + (d.paid_amount || 0), 0);
    const pending = debtors.filter(d => d.status !== "pago").length;
    const paid = debtors.filter(d => d.status === "pago").length;
    
    return { total, totalDebt, totalPaid, pending, paid, remaining: totalDebt - totalPaid };
  }, [debtors]);

  return (
    <div className="min-h-screen bg-slate-50">
      {/* Header */}
      <header className="bg-white border-b border-slate-200 sticky top-0 z-10">
        <div className="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
          <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div className="flex items-center gap-4">
              <Link to={createPageUrl("Dashboard")}>
                <Button variant="ghost" size="icon" className="shrink-0">
                  <ArrowLeft className="w-5 h-5" />
                </Button>
              </Link>
              <div>
                <h1 className="text-2xl font-bold text-slate-900">Fiado</h1>
                <p className="text-slate-500 text-sm mt-0.5">Controle de contas a receber</p>
              </div>
            </div>
            
            <Button 
              onClick={() => { setEditingDebtor(null); setIsFormOpen(true); }}
              className="bg-rose-600 hover:bg-rose-700 text-white"
            >
              <UserPlus className="w-4 h-4 mr-2" />
              Novo Fiado
            </Button>
          </div>
        </div>
      </header>

      <main className="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Stats Cards */}
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            className="bg-white rounded-xl border border-slate-200 p-4"
          >
            <div className="flex items-center gap-3">
              <div className="p-2 bg-slate-100 rounded-lg">
                <Users className="w-5 h-5 text-slate-600" />
              </div>
              <div>
                <p className="text-xs text-slate-500">Total Clientes</p>
                <p className="text-xl font-bold text-slate-800">{stats.total}</p>
              </div>
            </div>
          </motion.div>

          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.1 }}
            className="bg-white rounded-xl border border-slate-200 p-4"
          >
            <div className="flex items-center gap-3">
              <div className="p-2 bg-rose-100 rounded-lg">
                <DollarSign className="w-5 h-5 text-rose-600" />
              </div>
              <div>
                <p className="text-xs text-slate-500">A Receber</p>
                <p className="text-xl font-bold text-rose-600">
                  R$ {stats.remaining.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                </p>
              </div>
            </div>
          </motion.div>

          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.2 }}
            className="bg-white rounded-xl border border-slate-200 p-4"
          >
            <div className="flex items-center gap-3">
              <div className="p-2 bg-yellow-100 rounded-lg">
                <AlertCircle className="w-5 h-5 text-yellow-600" />
              </div>
              <div>
                <p className="text-xs text-slate-500">Pendentes</p>
                <p className="text-xl font-bold text-yellow-600">{stats.pending}</p>
              </div>
            </div>
          </motion.div>

          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.3 }}
            className="bg-white rounded-xl border border-slate-200 p-4"
          >
            <div className="flex items-center gap-3">
              <div className="p-2 bg-emerald-100 rounded-lg">
                <CheckCircle2 className="w-5 h-5 text-emerald-600" />
              </div>
              <div>
                <p className="text-xs text-slate-500">Quitados</p>
                <p className="text-xl font-bold text-emerald-600">{stats.paid}</p>
              </div>
            </div>
          </motion.div>
        </div>

        {/* Filters */}
        <div className="flex flex-col sm:flex-row gap-4 mb-6">
          <div className="relative flex-1">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
            <Input
              placeholder="Buscar por nome, telefone ou descrição..."
              className="pl-10"
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
            />
          </div>
          <div className="flex items-center gap-2">
            <Filter className="w-4 h-4 text-slate-400" />
            <Select value={filterStatus} onValueChange={setFilterStatus}>
              <SelectTrigger className="w-40">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">Todos</SelectItem>
                <SelectItem value="pendente">Pendentes</SelectItem>
                <SelectItem value="parcial">Parcial</SelectItem>
                <SelectItem value="pago">Pagos</SelectItem>
              </SelectContent>
            </Select>
          </div>
        </div>

        {/* Debtors List */}
        {isLoading ? (
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {[1, 2, 3, 4].map(i => (
              <div key={i} className="bg-white rounded-xl border border-slate-200 p-5 animate-pulse">
                <div className="flex items-center gap-3 mb-4">
                  <div className="w-12 h-12 bg-slate-200 rounded-xl" />
                  <div className="space-y-2">
                    <div className="h-4 bg-slate-200 rounded w-32" />
                    <div className="h-3 bg-slate-100 rounded w-24" />
                  </div>
                </div>
                <div className="h-20 bg-slate-100 rounded" />
              </div>
            ))}
          </div>
        ) : filteredDebtors.length === 0 ? (
          <div className="bg-white rounded-2xl border border-slate-200 p-12 text-center">
            <div className="w-16 h-16 mx-auto mb-4 bg-slate-100 rounded-2xl flex items-center justify-center">
              <Users className="w-8 h-8 text-slate-400" />
            </div>
            <h3 className="text-lg font-semibold text-slate-800 mb-1">
              {searchTerm || filterStatus !== "all" ? "Nenhum resultado encontrado" : "Nenhum devedor registrado"}
            </h3>
            <p className="text-slate-500 mb-4">
              {searchTerm || filterStatus !== "all" 
                ? "Tente buscar com outros termos" 
                : "Adicione seu primeiro cliente fiado"}
            </p>
            {!searchTerm && filterStatus === "all" && (
              <Button onClick={() => { setEditingDebtor(null); setIsFormOpen(true); }} className="bg-rose-600 hover:bg-rose-700">
                <UserPlus className="w-4 h-4 mr-2" />
                Adicionar Fiado
              </Button>
            )}
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {filteredDebtors.map((debtor, index) => (
              <DebtorCard
                key={debtor.id}
                debtor={debtor}
                index={index}
                onPayment={openPaymentModal}
                onEdit={openEditModal}
                onDelete={(id) => deleteMutation.mutate(id)}
              />
            ))}
          </div>
        )}
      </main>

      {/* Modals */}
      <DebtorForm
        open={isFormOpen}
        onOpenChange={(open) => { setIsFormOpen(open); if (!open) setEditingDebtor(null); }}
        onSubmit={handleFormSubmit}
        isSubmitting={createMutation.isPending || updateDebtorMutation.isPending}
        editingDebtor={editingDebtor}
      />

      <PaymentModal
        open={isPaymentOpen}
        onOpenChange={setIsPaymentOpen}
        debtor={selectedDebtor}
        onSubmit={handlePayment}
        isSubmitting={updateMutation.isPending}
      />
    </div>
  );
}